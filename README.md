# Telegram-бот для аналитики по видео

Бот, который понимает вопросы на русском языке и отвечает данными из базы статистики по видео. Просто пишешь "Сколько всего просмотров?" и получаешь число.

## Что умеет

- Считает метрики по видео: просмотры, лайки, комментарии, жалобы
- Отслеживает динамику: прирост за час, день, по конкретным видео
- Фильтрует по креаторам
- Понимает обычный русский язык (не нужно знать SQL)
- Безопасно: только чтение данных, никаких изменений

## Как это работает

Когда ты пишешь боту вопрос на русском:

1. **Бот получает сообщение** → отправляет текст в OpenAI API
2. **LLM анализирует запрос** → понимает, что нужно найти (например, "сумма просмотров")
3. **Генерируется SQL запрос** → LLM создает правильный SELECT на основе схемы БД
4. **Валидация** → проверяется, что запрос безопасный (только SELECT, без DROP/DELETE)
5. **Выполнение** → запрос идет в PostgreSQL, результат возвращается как число

Вся магия в промпте для LLM - там описана структура таблиц (`videos` и `video_snapshots`), поля, связи. Модель сама решает, какую таблицу использовать и какие агрегации применить.

## Что нужно для запуска

- Python 3.10 или новее
- PostgreSQL 12+
- Токен Telegram бота (получить у @BotFather)
- API ключ OpenAI (для GPT-4o или gpt-4o-mini)

## Быстрый старт

### 1. Клонируй и установи зависимости

```bash
git clone <repository-url>
cd rlt-test-bot
python -m venv .venv
source .venv/bin/activate  # Linux/Mac
pip install -r requirements.txt
```

### 2. Настрой переменные окружения

Создай файл `.env` в корне проекта:

```env
BOT_TOKEN=твой_токен_от_BotFather
OPENAI_API_KEY=твой_ключ_OpenAI
DB_HOST=localhost
DB_PORT=5432
DB_NAME=rlt_test_bot
DB_USER=postgres
DB_PASSWORD=твой_пароль
```

### 3. Создай базу данных

```bash
createdb rlt_test_bot
# или через psql:
psql -U postgres -c "CREATE DATABASE rlt_test_bot;"
```

### 4. Загрузи данные

Скачай JSON файл с данными и загрузи:

```bash
python scripts/load_data.py path/to/videos.json
```

Скрипт разберет JSON, создаст таблицы через SQLAlchemy и загрузит все видео со снапшотами.

### 5. Запусти бота

```bash
python main.py
```

Бот запустится, создаст таблицы (если их еще нет) и начнет слушать сообщения.

## Использование

Найди бота в Telegram, отправь `/start`. Потом просто пиши вопросы:

**Простая статистика:**
- "Сколько всего видео?"
- "Сколько просмотров у всех видео?"
- "Среднее количество лайков?"

**По креаторам:**
- "Сколько видео у креатора abc123?"
- "Сколько просмотров у креатора abc123?"

**Динамика (использует таблицу video_snapshots):**
- "Какой прирост просмотров за последний час?"
- "Сколько новых лайков за сегодня?"
- "Прирост комментариев за последние 24 часа?"

**По конкретному видео:**
- "Сколько просмотров у видео с id xyz?"
- "Сколько лайков у видео xyz?"

Бот вернет одно число - результат запроса.

## Структура проекта

```
rlt-test-bot/
├── main.py                    # Точка входа, обработчики сообщений
├── requirements.txt           # Зависимости
├── .env                       # Переменные окружения (не коммитится)
├── src/
│   ├── config.py              # Настройки через Pydantic
│   ├── database/
│   │   ├── models.py          # SQLAlchemy модели (Video, VideoSnapshot)
│   │   └── db.py              # Подключение к БД, сессии
│   └── utils/
│       ├── llm.py             # Генерация SQL через OpenAI
│       └── query_executor.py  # Выполнение запросов
└── scripts/
    └── load_data.py           # Загрузка JSON в БД
```

## Как устроено внутри

### База данных

Две таблицы:

**`videos`** - итоговая статистика по каждому видео:
- `id`, `creator_id`, `video_created_at`
- `views_count`, `likes_count`, `comments_count`, `reports_count`
- `created_at`, `updated_at`

**`video_snapshots`** - почасовые замеры:
- `video_id` (FK на videos)
- Текущие значения: `views_count`, `likes_count`, etc.
- Приращения: `delta_views_count`, `delta_likes_count`, etc.
- `created_at` - время замера

### LLM интеграция

В `src/utils/llm.py` есть промпт с описанием схемы БД. Когда приходит вопрос:

1. Промпт + вопрос отправляются в OpenAI
2. Модель генерирует SQL запрос
3. Запрос валидируется (только SELECT, проверка на опасные слова)
4. Если валиден - выполняется, результат возвращается

Промпт содержит примеры запросов и правила:
- Для итоговых значений → таблица `videos`
- Для динамики/прироста → таблица `video_snapshots` с полями `delta_*`
- Для фильтрации по дате → `video_created_at` или `created_at`
- Для фильтрации по креатору → `creator_id`

### Безопасность

Валидация SQL запросов:
- Разрешены только SELECT запросы
- Запрещены: DROP, DELETE, UPDATE, INSERT, ALTER, CREATE, TRUNCATE
- Проверка через регулярные выражения (чтобы "CREATE" в "CREATED_AT" не блокировалось)

## Технологии

- **aiogram 3.x** - асинхронный фреймворк для Telegram ботов
- **SQLAlchemy 2.0** - ORM для работы с PostgreSQL
- **OpenAI API** - GPT-4o для генерации SQL
- **Pydantic** - валидация настроек из .env
- **PostgreSQL** - хранение данных

## Возможные проблемы

**Бот не отвечает:**
- Проверь логи: `python main.py` выведет ошибки
- Убедись, что токен и API ключ правильные
- Проверь подключение к БД

**Ошибка "Generated query is not safe":**
- LLM сгенерировал некорректный SQL
- Попробуй переформулировать вопрос
- Проверь логи - там будет сгенерированный SQL

**База данных не подключается:**
- Убедись, что PostgreSQL запущен
- Проверь настройки в `.env`
- Попробуй подключиться вручную: `psql -U postgres -d rlt_test_bot`

## Лицензия

MIT
